<!doctype html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS SmartRouting AI Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Routing (OPS I 1) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body { margin:0; font-family:Inter, sans-serif; background:#f3f4f6; }
#map { height:400px; border-radius:12px; }
.chat-message { padding:10px; border-radius:8px; margin-bottom:6px; }
.chat-user { background:#667eea; color:white; margin-left:auto; }
.chat-ai { background:#e5e7eb; }
</style>
</head>

<body class="p-6">
<h1 class="text-2xl font-bold mb-4">POS SmartRouting AI Dashboard</h1>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <div class="lg:col-span-2">
    <div id="map"></div>
    <div id="offices-list" class="mt-4 space-y-2"></div>
  </div>

  <div>
    <div id="chat-messages" class="h-80 overflow-y-auto mb-2"></div>
    <form id="chat-form" class="flex gap-2">
      <input id="chat-input" class="flex-1 border p-2 rounded" placeholder="rute dari kcp paninggaran ke kcp pekalongan">
      <button class="bg-indigo-600 text-white px-4 rounded">Kirim</button>
    </form>
  </div>
</div>

<script>
/* =====================================================
   GLOBAL
===================================================== */
let map;
let allData = [];
let routingControl = null;

/* =====================================================
   MAP
===================================================== */
function initMap() {
    map = L.map("map").setView([-7.02, 109.62], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
}

/* =====================================================
   LOAD GEOJSON
===================================================== */
async function loadOutletGeoJSON() {
    const res = await fetch("data/outlet_pekalongan_final.geojson");
    const geojson = await res.json();

    const bounds = L.latLngBounds([]);

    allData = geojson.features.map((f, i) => {
        const p = f.properties;
        const [lng, lat] = f.geometry.coordinates;
        bounds.extend([lat, lng]);

        const office = {
            id: `geo_${i}`,
            type: "office",
            nama: `${p.jnskantor} ${p.nama_dirian}`,
            latitude: lat,
            longitude: lng,
            alamat: p.alamat_lengkap,
            jnskantor: p.jnskantor
        };

        L.marker([lat, lng]).addTo(map)
            .bindPopup(`<b>${office.nama}</b><br>${office.alamat}`);

        return office;
    });

    map.fitBounds(bounds);
    renderOfficesList();
}

/* =====================================================
   RENDER LIST
===================================================== */
function renderOfficesList() {
    const el = document.getElementById("offices-list");
    el.innerHTML = allData.map(o =>
        `<div class="border p-2 rounded">${o.nama}</div>`
    ).join("");
}

/* =====================================================
   AI + ROUTING
===================================================== */
function findOffice(keyword) {
    return allData.find(o =>
        o.nama.toLowerCase().includes(keyword.toLowerCase())
    );
}

function drawRoute(from, to) {
    if (routingControl) map.removeControl(routingControl);

    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(from.latitude, from.longitude),
            L.latLng(to.latitude, to.longitude)
        ],
        addWaypoints:false,
        draggableWaypoints:false,
        show:false
    }).addTo(map);
}

/* =====================================================
   CHAT
===================================================== */
document.getElementById("chat-form").addEventListener("submit", e => {
    e.preventDefault();
    const input = document.getElementById("chat-input");
    const msg = input.value.toLowerCase();
    input.value = "";

    addMsg(msg, "user");

    const m = msg.match(/dari (.+) ke (.+)/);
    if (!m) {
        addMsg("Format: rute dari KCP Paninggaran ke KCP Pekalongan", "ai");
        return;
    }

    const asal = findOffice(m[1]);
    const tujuan = findOffice(m[2]);

    if (!asal || !tujuan) {
        addMsg("Kantor tidak ditemukan di data.", "ai");
        return;
    }

    drawRoute(asal, tujuan);

    addMsg(
`üß≠ Rute Jalan (OpenStreetMap)

Dari:
${asal.nama}

Ke:
${tujuan.nama}

üìç Jalur jalan ditampilkan di peta.`,
    "ai");
});

function addMsg(text, sender) {
    const box = document.getElementById("chat-messages");
    const d = document.createElement("div");
    d.className = `chat-message chat-${sender}`;
    d.textContent = text;
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
}

/* =====================================================
   INIT
===================================================== */
initMap();
loadOutletGeoJSON();
</script>
</body>
</html>

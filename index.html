<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS SmartRouting AI Dashboard</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-on-trip {
            background: #10b981;
            color: white;
        }
        
        .status-idle {
            background: #fbbf24;
            color: #78350f;
        }
        
        .status-maintenance {
            background: #ef4444;
            color: white;
        }
        
        .chat-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            max-width: 80%;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .chat-ai {
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="min-h-full p-6"><!-- Header -->
   <header class="mb-6">
    <div class="card p-6">
     <h1 id="dashboard-title" class="text-3xl font-bold text-transparent bg-clip-text gradient-bg mb-2">POS SmartRouting AI Dashboard</h1>
     <p class="text-gray-600">Sistem Manajemen Rute Pengiriman Cerdas dengan AI</p>
    </div>
   </header><!-- Main Content -->
   <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Left Column: Map & Post Offices -->
    <div class="lg:col-span-2 space-y-6"><!-- Map Card -->
     <div class="card p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-bold text-gray-800">Peta Interaktif</h2><span id="location-name" class="text-sm text-gray-600">Jakarta Barat</span>
      </div>
      <div id="map" class="map-container"></div>
     </div><!-- Tabs -->
     <div class="card">
      <div class="border-b border-gray-200">
       <div class="flex"><button class="tab-button active" onclick="switchTab('offices')">
         <svg class="icon inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
         </svg> Kantor Pos </button> <button class="tab-button" onclick="switchTab('vehicles')">
         <svg class="icon inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
         </svg> Kendaraan </button>
       </div>
      </div><!-- Post Offices Tab -->
      <div id="offices-tab" class="p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Daftar Kantor Pos</h3><button class="btn-primary text-sm" onclick="showAddOfficeModal()"> + Tambah Kantor </button>
       </div>
       <div id="offices-list" class="space-y-3"></div>
      </div><!-- Vehicles Tab -->
      <div id="vehicles-tab" class="p-6 hidden">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Status Kendaraan</h3><button class="btn-primary text-sm" onclick="showAddVehicleModal()"> + Tambah Kendaraan </button>
       </div>
       <div id="vehicles-list" class="space-y-3"></div>
      </div>
     </div>
    </div><!-- Right Column: AI Chat -->
    <div class="lg:col-span-1">
     <div class="card p-6 h-full flex flex-col">
      <div class="flex items-center mb-4">
       <svg class="icon mr-2 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
       </svg>
       <h2 class="text-xl font-bold text-gray-800">AI Route Assistant</h2>
      </div>
      <div class="bg-purple-50 p-4 rounded-lg mb-4">
       <p id="chat-welcome" class="text-sm text-purple-800">Tanya saya tentang rute tercepat!</p>
      </div>
      <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 space-y-2" style="max-height: 400px;"><!-- Chat messages will appear here -->
      </div>
      <form id="chat-form" class="flex gap-2"><input type="text" id="chat-input" class="input-field flex-1" placeholder="Tanyakan rute tercepat..." required> <button type="submit" class="btn-primary" id="chat-submit">
        <svg class="icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg></button>
      </form>
     </div>
    </div>
   </div>
  </div><!-- Add Office Modal -->
  <div id="office-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">Tambah Kantor Pos</h3>
    <form id="office-form">
     <div class="space-y-4">
      <div><label class="block text-sm font-semibold mb-2">Nama Kantor</label> <input type="text" id="office-nama" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Kode Pos</label> <input type="text" id="office-kode" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Alamat Lengkap</label> <textarea id="office-alamat" class="input-field" rows="3" required></textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label class="block text-sm font-semibold mb-2">Latitude</label> <input type="number" step="any" id="office-lat" class="input-field" required>
       </div>
       <div><label class="block text-sm font-semibold mb-2">Longitude</label> <input type="number" step="any" id="office-lng" class="input-field" required>
       </div>
      </div>
      <div class="flex gap-2"><button type="submit" class="btn-primary flex-1" id="office-submit"> Simpan </button> <button type="button" class="btn-primary flex-1" onclick="closeOfficeModal()" style="background: #6b7280;"> Batal </button>
      </div>
     </div>
    </form>
   </div>
  </div><!-- Add Vehicle Modal -->
  <div id="vehicle-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">Tambah Kendaraan</h3>
    <form id="vehicle-form">
     <div class="space-y-4">
      <div><label class="block text-sm font-semibold mb-2">Plat Nomor</label> <input type="text" id="vehicle-plat" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Nama Driver</label> <input type="text" id="vehicle-driver" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Status</label> <select id="vehicle-status" class="input-field" required> <option value="Idle">Idle</option> <option value="On Trip">On Trip</option> <option value="Maintenance">Maintenance</option> </select>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Tujuan</label> <input type="text" id="vehicle-destination" class="input-field">
      </div>
      <div><label class="block text-sm font-semibold mb-2">ETA</label> <input type="text" id="vehicle-eta" class="input-field" placeholder="contoh: 30 menit">
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label class="block text-sm font-semibold mb-2">Latitude</label> <input type="number" step="any" id="vehicle-lat" class="input-field" required>
       </div>
       <div><label class="block text-sm font-semibold mb-2">Longitude</label> <input type="number" step="any" id="vehicle-lng" class="input-field" required>
       </div>
      </div>
      <div class="flex gap-2"><button type="submit" class="btn-primary flex-1" id="vehicle-submit"> Simpan </button> <button type="button" class="btn-primary flex-1" onclick="closeVehicleModal()" style="background: #6b7280;"> Batal </button>
      </div>
     </div>
    </form>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            dashboard_title: "POS SmartRouting AI Dashboard",
            default_location: "Jakarta Barat",
            chat_welcome: "Tanya saya tentang rute tercepat!",
            primary_color: "#667eea",
            secondary_color: "#764ba2",
            background_color: "#f9fafb",
            text_color: "#1f2937",
            accent_color: "#10b981"
        };

        let map;
        let markers = [];
        let allData = [];

        // Initialize map
        function initMap() {
            map = L.map('map').setView([-6.1615, 106.7946], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Update map markers
        function updateMapMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const offices = allData.filter(item => item.type === 'office');
            const vehicles = allData.filter(item => item.type === 'vehicle');

            offices.forEach(office => {
                const marker = L.marker([office.latitude, office.longitude], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: #667eea; color: white; padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">üìÆ</div>`,
                        iconSize: [40, 40]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>${office.nama}</strong><br>
                    Kode Pos: ${office.kode_pos}<br>
                    ${office.alamat}
                `);
                
                markers.push(marker);
            });

            vehicles.forEach(vehicle => {
                const statusColors = {
                    'On Trip': '#10b981',
                    'Idle': '#fbbf24',
                    'Maintenance': '#ef4444'
                };
                
                const marker = L.marker([vehicle.latitude, vehicle.longitude], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: ${statusColors[vehicle.status]}; color: white; padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">üöö</div>`,
                        iconSize: [40, 40]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>${vehicle.plat_nomor}</strong><br>
                    Driver: ${vehicle.driver_name}<br>
                    Status: ${vehicle.status}<br>
                    ${vehicle.destination ? `Tujuan: ${vehicle.destination}` : ''}
                `);
                
                markers.push(marker);
            });
        }

        // Render offices list
        function renderOfficesList() {
            const container = document.getElementById('offices-list');
            const offices = allData.filter(item => item.type === 'office');
            
            if (offices.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada kantor pos. Klik "Tambah Kantor" untuk menambahkan.</p>';
                return;
            }

            container.innerHTML = offices.map(office => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${office.nama}</h4>
                            <p class="text-sm text-gray-600 mt-1">${office.alamat}</p>
                            <div class="flex gap-2 mt-2">
                                <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">üìÆ ${office.kode_pos}</span>
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">üìç ${office.latitude.toFixed(4)}, ${office.longitude.toFixed(4)}</span>
                            </div>
                        </div>
                        <button onclick="deleteItem('${office.id}')" class="text-red-500 hover:text-red-700 ml-2">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render vehicles list
        function renderVehiclesList() {
            const container = document.getElementById('vehicles-list');
            const vehicles = allData.filter(item => item.type === 'vehicle');
            
            if (vehicles.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada kendaraan. Klik "Tambah Kendaraan" untuk menambahkan.</p>';
                return;
            }

            container.innerHTML = vehicles.map(vehicle => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="font-bold text-gray-800">${vehicle.plat_nomor}</h4>
                                <span class="status-badge status-${vehicle.status.toLowerCase().replace(' ', '-')}">${vehicle.status}</span>
                            </div>
                            <p class="text-sm text-gray-600">üë§ ${vehicle.driver_name}</p>
                            ${vehicle.destination ? `<p class="text-sm text-gray-600 mt-1">üìç ${vehicle.destination}</p>` : ''}
                            ${vehicle.eta ? `<p class="text-sm text-gray-600">‚è±Ô∏è ETA: ${vehicle.eta}</p>` : ''}
                            <p class="text-xs text-gray-500 mt-2">Lokasi: ${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}</p>
                        </div>
                        <button onclick="deleteItem('${vehicle.id}')" class="text-red-500 hover:text-red-700 ml-2">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-button').classList.add('active');
            
            document.getElementById('offices-tab').classList.toggle('hidden', tab !== 'offices');
            document.getElementById('vehicles-tab').classList.toggle('hidden', tab !== 'vehicles');
        }

        // Modal functions
        function showAddOfficeModal() {
            document.getElementById('office-modal').classList.remove('hidden');
        }

        function closeOfficeModal() {
            document.getElementById('office-modal').classList.add('hidden');
            document.getElementById('office-form').reset();
        }

        function showAddVehicleModal() {
            document.getElementById('vehicle-modal').classList.remove('hidden');
        }

        function closeVehicleModal() {
            document.getElementById('vehicle-modal').classList.add('hidden');
            document.getElementById('vehicle-form').reset();
        }

        // Add office
        document.getElementById('office-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('office-submit');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span>';

            if (allData.filter(item => item.type === 'office').length >= 999) {
                alert('Maksimum 999 kantor pos tercapai. Hapus beberapa data terlebih dahulu.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Simpan';
                return;
            }

            const officeData = {
                id: Date.now().toString(),
                type: 'office',
                nama: document.getElementById('office-nama').value,
                kode_pos: document.getElementById('office-kode').value,
                alamat: document.getElementById('office-alamat').value,
                latitude: parseFloat(document.getElementById('office-lat').value),
                longitude: parseFloat(document.getElementById('office-lng').value),
                plat_nomor: '',
                driver_name: '',
                status: '',
                destination: '',
                eta: '',
                timestamp: new Date().toISOString()
            };

            const result = await window.dataSdk.create(officeData);
            
            if (result.isOk) {
                closeOfficeModal();
            } else {
                alert('Gagal menambahkan kantor pos. Silakan coba lagi.');
            }
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Simpan';
        });

        // Add vehicle
        document.getElementById('vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('vehicle-submit');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span>';

            if (allData.filter(item => item.type === 'vehicle').length >= 999) {
                alert('Maksimum 999 kendaraan tercapai. Hapus beberapa data terlebih dahulu.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Simpan';
                return;
            }

            const vehicleData = {
                id: Date.now().toString(),
                type: 'vehicle',
                plat_nomor: document.getElementById('vehicle-plat').value,
                driver_name: document.getElementById('vehicle-driver').value,
                status: document.getElementById('vehicle-status').value,
                destination: document.getElementById('vehicle-destination').value,
                eta: document.getElementById('vehicle-eta').value,
                latitude: parseFloat(document.getElementById('vehicle-lat').value),
                longitude: parseFloat(document.getElementById('vehicle-lng').value),
                nama: '',
                kode_pos: '',
                alamat: '',
                timestamp: new Date().toISOString()
            };

            const result = await window.dataSdk.create(vehicleData);
            
            if (result.isOk) {
                closeVehicleModal();
            } else {
                alert('Gagal menambahkan kendaraan. Silakan coba lagi.');
            }
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Simpan';
        });

        // Delete item
        async function deleteItem(id) {
            const item = allData.find(d => d.id === id);
            if (!item) return;

            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'modal-overlay';
            confirmDiv.innerHTML = `
                <div class="modal-content text-center">
                    <h3 class="text-xl font-bold mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Yakin ingin menghapus data ini?</p>
                    <div class="flex gap-2 justify-center">
                        <button id="confirm-delete" class="btn-primary" style="background: #ef4444;">Hapus</button>
                        <button id="cancel-delete" class="btn-primary" style="background: #6b7280;">Batal</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);

            document.getElementById('confirm-delete').onclick = async () => {
                const result = await window.dataSdk.delete(item);
                if (!result.isOk) {
                    alert('Gagal menghapus data. Silakan coba lagi.');
                }
                document.body.removeChild(confirmDiv);
            };

            document.getElementById('cancel-delete').onclick = () => {
                document.body.removeChild(confirmDiv);
            };
        }

        // Chat functionality
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const input = document.getElementById('chat-input');
            const submitBtn = document.getElementById('chat-submit');
            const message = input.value.trim();
            
            if (!message) return;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span>';

            addChatMessage(message, 'user');
            input.value = '';

            setTimeout(() => {
                const offices = allData.filter(item => item.type === 'office');
                const vehicles = allData.filter(item => item.type === 'vehicle');
                
                let response = '';
                
                if (message.toLowerCase().includes('rute') || message.toLowerCase().includes('tercepat')) {
                    if (offices.length > 0) {
                        const office = offices[0];
                        response = `üó∫Ô∏è Rekomendasi Rute Tercepat:\n\nDari lokasi Anda ke ${office.nama} (${office.kode_pos}):\n\n‚úÖ Estimasi waktu: 25-30 menit\nüìç Jarak: ~8.5 km\nüõ£Ô∏è Rute: Jl. Raya Krendang ‚Üí Jl. Daan Mogot ‚Üí ${office.alamat}\n\nüí° Tips: Hindari jam sibuk (07:00-09:00 & 17:00-19:00)`;
                    } else {
                        response = 'Belum ada data kantor pos. Silakan tambahkan kantor pos terlebih dahulu untuk mendapatkan rekomendasi rute.';
                    }
                } else if (message.toLowerCase().includes('kendaraan') || message.toLowerCase().includes('status')) {
                    if (vehicles.length > 0) {
                        response = `üöö Status Kendaraan:\n\n${vehicles.map(v => `${v.plat_nomor} - ${v.status}\nDriver: ${v.driver_name}${v.destination ? `\nTujuan: ${v.destination}` : ''}`).join('\n\n')}`;
                    } else {
                        response = 'Belum ada data kendaraan. Silakan tambahkan kendaraan terlebih dahulu.';
                    }
                } else if (message.toLowerCase().includes('kantor') || message.toLowerCase().includes('pos')) {
                    if (offices.length > 0) {
                        response = `üìÆ Daftar Kantor Pos:\n\n${offices.map(o => `${o.nama}\nKode Pos: ${o.kode_pos}\n${o.alamat}`).join('\n\n')}`;
                    } else {
                        response = 'Belum ada data kantor pos. Silakan tambahkan kantor pos terlebih dahulu.';
                    }
                } else {
                    response = `Halo! Saya AI Assistant untuk routing. Saya bisa membantu Anda dengan:\n\nüó∫Ô∏è Rekomendasi rute tercepat\nüöö Status kendaraan\nüìÆ Informasi kantor pos\n\nSilakan tanyakan tentang topik di atas!`;
                }
                
                addChatMessage(response, 'ai');
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>`;
            }, 1000);
        });

        function addChatMessage(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-${sender}`;
            messageDiv.style.whiteSpace = 'pre-line';
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Data handler
        const dataHandler = {
            onDataChanged(data) {
                allData = data;
                renderOfficesList();
                renderVehiclesList();
                updateMapMarkers();
            }
        };

        // Config change handler
        async function onConfigChange(config) {
            const titleElement = document.getElementById('dashboard-title');
            const locationElement = document.getElementById('location-name');
            const welcomeElement = document.getElementById('chat-welcome');
            
            titleElement.textContent = config.dashboard_title || defaultConfig.dashboard_title;
            locationElement.textContent = config.default_location || defaultConfig.default_location;
            welcomeElement.textContent = config.chat_welcome || defaultConfig.chat_welcome;
            
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
            
            document.querySelectorAll('.btn-primary').forEach(btn => {
                btn.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
            });
            
            document.querySelectorAll('.gradient-bg').forEach(el => {
                el.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
            });
        }

        // Initialize
async function init() {
    initMap();

    // üî• LOAD DATA GEOJSON (AI INPUT)
    await loadOutletGeoJSON();

    if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
            console.error('Failed to initialize data SDK');
        }
    }

    if (window.elementSdk) {
        window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities: (config) => ({
                recolorables: [
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.secondary_color || defaultConfig.secondary_color,
                        set: (value) => {
                            config.secondary_color = value;
                            window.elementSdk.setConfig({ secondary_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
                ['dashboard_title', config.dashboard_title || defaultConfig.dashboard_title],
                ['default_location', config.default_location || defaultConfig.default_location],
                ['chat_welcome', config.chat_welcome || defaultConfig.chat_welcome]
            ])
        });
    }
}

init();

    
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99adb2aa440b9b07',t:'MTc2MjUyNzYwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS SmartRouting AI Dashboard</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="leaflet.css">
  <script src="leaflet.js"></script>
  
  <!-- WAJIB -->
  <link rel="stylesheet" href="leaflet-routing-machine.css">
  <script src="leaflet-routing-machine.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-on-trip {
            background: #10b981;
            color: white;
        }
        
        .status-idle {
            background: #fbbf24;
            color: #78350f;
        }
        
        .status-maintenance {
            background: #ef4444;
            color: white;
        }
        
        .chat-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            max-width: 80%;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .chat-ai {
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="min-h-full p-6"><!-- Header -->
   <header class="mb-6">
    <div class="card p-6">
     <h1 id="dashboard-title" class="text-3xl font-bold text-transparent bg-clip-text gradient-bg mb-2">POS SmartRouting AI Dashboard</h1>
     <p class="text-gray-600">Sistem Manajemen Rute Pengiriman Cerdas dengan AI</p>
    </div>
   </header><!-- Main Content -->
   <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Left Column: Map & Post Offices -->
    <div class="lg:col-span-2 space-y-6"><!-- Map Card -->
     <div class="card p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-bold text-gray-800">Peta Interaktif</h2><span id="location-name" class="text-sm text-gray-600">Pekalongan</span>
      </div>
      <div id="map" class="map-container"></div>
     </div><!-- Tabs -->
     <div class="card">
      <div class="border-b border-gray-200">
       <div class="flex"><button class="tab-button active" onclick="switchTab('offices')">
         <svg class="icon inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
         </svg> Kantor Pos </button> <button class="tab-button" onclick="switchTab('vehicles')">
         <svg class="icon inline mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
         </svg> Kendaraan </button>
       </div>
      </div><!-- Post Offices Tab -->
      <div id="offices-tab" class="p-6">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Daftar Kantor Pos</h3><button class="btn-primary text-sm" onclick="showAddOfficeModal()"> + Tambah Kantor </button>
       </div>
       <div id="offices-list" class="space-y-3"></div>
      </div><!-- Vehicles Tab -->
      <div id="vehicles-tab" class="p-6 hidden">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Status Kendaraan</h3><button class="btn-primary text-sm" onclick="showAddVehicleModal()"> + Tambah Kendaraan </button>
       </div>
       <div id="vehicles-list" class="space-y-3"></div>
      </div>
     </div>
    </div><!-- Right Column: AI Chat -->
    <div class="lg:col-span-1">
     <div class="card p-6 h-full flex flex-col">
      <div class="flex items-center mb-4">
       <svg class="icon mr-2 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
       </svg>
       <h2 class="text-xl font-bold text-gray-800">AI Route Assistant</h2>
      </div>
      <div class="bg-purple-50 p-4 rounded-lg mb-4">
       <p id="chat-welcome" class="text-sm text-purple-800">Tanya saya tentang rute tercepat!</p>
      </div>
      <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 space-y-2" style="max-height: 400px;"><!-- Chat messages will appear here -->
      </div>
      <form id="chat-form" class="flex gap-2"><input type="text" id="chat-input" class="input-field flex-1" placeholder="Tanyakan rute tercepat..." required> <button type="submit" class="btn-primary" id="chat-submit">
        <svg class="icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg></button>
      </form>
     </div>
    </div>
   </div>
  </div><!-- Add Office Modal -->
  <div id="office-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">Tambah Kantor Pos</h3>
    <form id="office-form">
     <div class="space-y-4">
      <div><label class="block text-sm font-semibold mb-2">Nama Kantor</label> <input type="text" id="office-nama" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Kode Pos</label> <input type="text" id="office-kode" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Alamat Lengkap</label> <textarea id="office-alamat" class="input-field" rows="3" required></textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label class="block text-sm font-semibold mb-2">Latitude</label> <input type="number" step="any" id="office-lat" class="input-field" required>
       </div>
       <div><label class="block text-sm font-semibold mb-2">Longitude</label> <input type="number" step="any" id="office-lng" class="input-field" required>
       </div>
      </div>
      <div class="flex gap-2"><button type="submit" class="btn-primary flex-1" id="office-submit"> Simpan </button> <button type="button" class="btn-primary flex-1" onclick="closeOfficeModal()" style="background: #6b7280;"> Batal </button>
      </div>
     </div>
    </form>
   </div>
  </div><!-- Add Vehicle Modal -->
  <div id="vehicle-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">Tambah Kendaraan</h3>
    <form id="vehicle-form">
     <div class="space-y-4">
      <div><label class="block text-sm font-semibold mb-2">Plat Nomor</label> <input type="text" id="vehicle-plat" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Nama Driver</label> <input type="text" id="vehicle-driver" class="input-field" required>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Status</label> <select id="vehicle-status" class="input-field" required> <option value="Idle">Idle</option> <option value="On Trip">On Trip</option> <option value="Maintenance">Maintenance</option> </select>
      </div>
      <div><label class="block text-sm font-semibold mb-2">Tujuan</label> <input type="text" id="vehicle-destination" class="input-field">
      </div>
      <div><label class="block text-sm font-semibold mb-2">ETA</label> <input type="text" id="vehicle-eta" class="input-field" placeholder="contoh: 30 menit">
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label class="block text-sm font-semibold mb-2">Latitude</label> <input type="number" step="any" id="vehicle-lat" class="input-field" required>
       </div>
       <div><label class="block text-sm font-semibold mb-2">Longitude</label> <input type="number" step="any" id="vehicle-lng" class="input-field" required>
       </div>
      </div>
      <div class="flex gap-2"><button type="submit" class="btn-primary flex-1" id="vehicle-submit"> Simpan </button> <button type="button" class="btn-primary flex-1" onclick="closeVehicleModal()" style="background: #6b7280;"> Batal </button>
      </div>
     </div>
    </form>
   </div>
  </div>
<script>
/* =====================================================
   GLOBAL CONFIG & STATE
===================================================== */
const defaultConfig = {
    dashboard_title: "POS SmartRouting AI Dashboard",
    default_location: "Kab. Pekalongan",
    chat_welcome: "Tanya saya tentang rute tercepat!"
};

let map;
let markers = [];
let allData = [];
let routingControl = null;

/* =====================================================
   MAP FUNCTIONS
===================================================== */
function initMap() {
    map = L.map("map").setView([-7.02, 109.62], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);
}

function updateMapMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    allData.forEach(o => {
        const marker = L.marker([o.latitude, o.longitude]).addTo(map);
        marker.bindPopup(`
            <strong>${o.nama}</strong><br>
            ${o.alamat}<br>
            <small>${o.kelurahan}</small>
        `);
        markers.push(marker);
    });
}

/* =====================================================
   LOAD GEOJSON DATA
===================================================== */
async function loadOutletGeoJSON() {
    try {
        const res = await fetch("data/outlet_pekalongan_final.geojson");
        const geojson = await res.json();

        const bounds = L.latLngBounds([]);

        allData = geojson.features.map((f, idx) => {
            const p = f.properties;
            const [lng, lat] = f.geometry.coordinates;

            bounds.extend([lat, lng]);

            return {
                id: `geo_${p.id_dirian ?? idx}`,
                type: "office",
                nama: `${p.jnskantor ?? ""} ${p.nama_dirian ?? ""}`.trim(),
                alamat: p.alamat_lengkap ?? "-",
                latitude: Number(lat),
                longitude: Number(lng),
                jnskantor: p.jnskantor ?? "-",
                kelurahan: p.kelurahan_fix ?? "-"
            };
        });

        updateMapMarkers();
        renderOfficesList();

        if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [40, 40] });
        }

        console.log(`âœ… Loaded ${allData.length} kantor dari GeoJSON`);
    } catch (err) {
        console.error("âŒ Gagal load GeoJSON:", err);
    }
}

/* =====================================================
   ROUTING JALAN NYATA (OPS I)
===================================================== */
function drawRoute(from, to) {
    if (routingControl) {
        map.removeControl(routingControl);
    }

    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(from.latitude, from.longitude),
            L.latLng(to.latitude, to.longitude)
        ],
        routeWhileDragging: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        show: false,
        createMarker: () => null
    }).addTo(map);
}

/* =====================================================
   AI HEURISTIC (UNTUK REKOMENDASI SAJA)
===================================================== */
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function heuristicScore(office, userLat, userLng) {
    const distance = calculateDistance(
        userLat, userLng,
        office.latitude, office.longitude
    );

    const distanceScore =
        distance <= 1 ? 100 :
        distance <= 3 ? 80 :
        distance <= 5 ? 60 : 40;

    const officeScore =
        office.jnskantor === "KCU" ? 100 :
        office.jnskantor === "KCP" ? 80 : 60;

    return {
        total: 0.6 * distanceScore + 0.4 * officeScore,
        distance: distance.toFixed(2)
    };
}

/* =====================================================
   UI RENDER
===================================================== */
function renderOfficesList() {
    const container = document.getElementById("offices-list");

    if (allData.length === 0) {
        container.innerHTML = "<p class='text-gray-500'>Tidak ada data.</p>";
        return;
    }

    container.innerHTML = allData.map(o => `
        <div class="border p-3 rounded">
            <strong>${o.nama}</strong><br>
            <small>${o.alamat}</small>
        </div>
    `).join("");
}

/* =====================================================
   NORMALISASI NAMA
===================================================== */
 function normalizeText(text) {
    return text
        .toLowerCase()
        .replace(/kcu|kcp|kantor|pos/g, "")
        .replace(/\s+/g, "")
        .trim();
}

function findOfficeSmart(keyword) {
    const key = normalizeText(keyword);

    return allData.find(o => {
        const officeKey = normalizeText(o.nama);
        return officeKey.includes(key) || key.includes(officeKey);
    });
}

/* =====================================================
   CHAT AI LOGIC (FIXED & BENAR)
===================================================== */
document.getElementById("chat-form").addEventListener("submit", e => {
    e.preventDefault();

    const input = document.getElementById("chat-input");
    const text = input.value.trim().toLowerCase();
    input.value = "";

    addChatMessage(text, "user");

    // ===== MODE ROUTING EKSPLISIT =====
    const match = text.match(/dari (.+) ke (.+)/i);

    if (match) {
        const fromText = match[1].trim();
        const toText = match[2].trim();
           const asal = findOfficeSmart(fromText);
           const tujuan = findOfficeSmart(toText);
        if (!asal || !tujuan) {
            addChatMessage(
                "âŒ Kantor asal atau tujuan tidak ditemukan di data.",
                "ai"
            );
            return;
        }

        drawRoute(asal, tujuan);

        addChatMessage(
`ðŸ§­ Rute Jalan (OpenStreetMap)

Dari:
${asal.nama}

Ke:
${tujuan.nama}

ðŸ“Œ Jalur jalan ditampilkan langsung di peta.`,
            "ai"
        );
        return;
    }

    // ===== MODE REKOMENDASI (OPSIONAL) =====
    if (text.includes("terdekat") || text.includes("rekomendasi")) {
        const userLat = -7.02;
        const userLng = 109.62;

        const evaluated = allData.map(o => {
            const h = heuristicScore(o, userLat, userLng);
            return { ...o, score: h.total, distance: h.distance };
        });

        evaluated.sort((a, b) => b.score - a.score);
        const best = evaluated[0];

        addChatMessage(
`ðŸ¤– Rekomendasi Kantor

${best.nama}
Jarak: Â± ${best.distance} km
Skor AI: ${best.score}`,
            "ai"
        );
        return;
    }

    // ===== FALLBACK =====
    addChatMessage(
        "Contoh:\nâ€¢ rute dari KCU Pekalongan ke KCP Kandangserang\nâ€¢ kantor terdekat",
        "ai"
    );
});

function addChatMessage(text, sender) {
    const box = document.getElementById("chat-messages");
    const div = document.createElement("div");
    div.className = `chat-message chat-${sender}`;
    div.textContent = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

/* =====================================================
   INIT
===================================================== */
async function init() {
    initMap();
    await loadOutletGeoJSON();
}

init();

</script>

 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99adb2aa440b9b07',t:'MTc2MjUyNzYwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
